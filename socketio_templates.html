<!DOCTYPE HTML>
<html>
<head>
    <title>Rezzi</title>
    <script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.min.js"></script>
</head>
<body>
    <form id="connect" method="POST" action="#">
        <input type="submit" value="Record">
    </form>
    <form id="disconnect" method="POST" action="#">
        <input type="submit" value="Stop">
    </form>
    <script>
      var socket = null;
      var mediaStream = null;

      // prepare button state
      $('#disconnect input')[0].disabled = true;

      // audio functions
      function initializeRecorder(stream){
         mediaStream = stream;

         // get sample rate
         audio_context = new AudioContext;
         sampleRate = audio_context.sampleRate;
         console.log('<sample_rate>', sampleRate);
         socket.emit('sample_rate', sampleRate);

         var audioInput = audio_context.createMediaStreamSource(stream);

         console.log("Created media stream.");

         var bufferSize = 4096;
         // record only 1 channel
         var recorder = audio_context.createScriptProcessor(bufferSize, 1, 1);
         // specify the processing function
         recorder.onaudioprocess = recorderProcess;
         // connect stream to our recorder
         audioInput.connect(recorder);
         // connect our recorder to the previous destination
         recorder.connect(audio_context.destination);          
      }
      function recorderProcess(e) {
        var left = e.inputBuffer.getChannelData(0);
        socket.emit('audio', left);
      }
      function convertFloat32ToInt16(buffer) {
        l = buffer.length;
        buf = new Int16Array(l);
        while (l--) {
          buf[l] = Math.min(1, buffer[l])*0x7FFF;
        }
        console.log(buf);
        return buf.buffer;
      }

      $('form#connect').submit(function(event) {
          if(socket == null){
            socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);
            socket.on('connect', function() {
                navigator.getUserMedia({audio: true}, initializeRecorder, function(a, b, c){
                  console.log(a, b, c);
                });
            });

            socket.on('my_response', function (msg) {
                console.log(msg);
                var audioPlay = new Audio(msg.data);
                audioPlay.play();
            });
          }
          else {
            socket.disconnect();
            socket.connect();
          }
          $('#connect input')[0].disabled = true;
          $('#disconnect input')[0].disabled = false;
          return false;
      });
      $('form#disconnect').submit(function(event) {
          mediaStream.getAudioTracks()[0].stop();
          audio_context.close();
          socket.emit('disconnect_request');
          $('#connect input')[0].disabled = false;
          $('#disconnect input')[0].disabled = true;
          return false;
      });
    </script>
</body>
</html>
